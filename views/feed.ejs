<% include ./partials/header.ejs %>
  <style>
    @keyframes spin-ring {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .spin-border {
      animation: spin-ring 2s linear infinite;
    }
  </style>

  <div class="w-full min-h-screen bg-[#2B2B2B] text-white py-5">
    <!-- Navbar -->
    <div class="w-full px-4 md:px-8 lg:px-12 flex items-center justify-between">
      <a href="/feed">
        <img class="w-1/4 md:w-32 lg:w-40" src="/images/logo.png" alt="">
      </a>
      <div class="icons -mt-2 flex gap-5 items-center text-xl md:text-2xl">
        <a href="/story/add">
          <i class="ri-add-circle-line"></i>
        </a>
        <a href="https://www.messenger.com/">
          <i class="ri-messenger-line"></i>
        </a>
      </div>
    </div>

    <!-- Story Section -->
    <div class="story px-3 flex gap-3 overflow-auto mt-5 md:justify-center">
      <% if (stories.length> 0) { %>
        <% stories.forEach(story=> { %>
          <a href="/story/<%= story.user?.username %>">
            <div class="rotating-ring circle flex-shrink-0 relative w-[18vw] h-[18vw] md:w-[90px] md:h-[90px]">
              <div class="ring-border absolute inset-0 rounded-full"
                style="background: conic-gradient(from 0deg, #8b5cf6, #ec4899, #f97316, #8b5cf6); padding: 3px;">
              </div>
              <div class="absolute inset-[3px] rounded-full overflow-hidden bg-black">
                <img class="w-full h-full object-cover object-top" src="data:<%= story.user?.profileImage.contentType %>;base64,<%= story.user?.profileImage.data?.toString('base64') %>"
                  alt="">
              </div>
            </div>
          </a>
          <% }) %>
            <% } %>
    </div>

    <!-- Feed Grid -->
    <div class="parent posts mb-20 mt-8 max-w-6xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 px-4">
      <% if (posts.length> 0) { %>
        <% posts.reverse().forEach(post=> { %>
          <div
            class="post w-full bg-[#1F1F1F] rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300">
            <div class="title px-4 pt-4 flex items-center gap-3">
              <a href="/story/<%= post.user?.username %>">
                <div class="rotating-ring relative w-12 h-12 flex-shrink-0">
                  <div class="ring-border absolute inset-0 rounded-full"
                    style="background: conic-gradient(from 0deg, #8b5cf6, #ec4899, #f97316, #8b5cf6); padding: 2px;">
                  </div>
                  <div class="absolute inset-[2px] rounded-full overflow-hidden bg-black">
                    <img src="data:<%= post.user?.profileImage.contentType %>;base64,<%= post.user?.profileImage.data?.toString('base64') %>" alt=""
                      class="w-full h-full rounded-full object-cover">
                  </div>
                </div>
              </a>
              <div>
                <a href="/profile/<%= post.user?.username %>">
                  <h4 class="text-sm md:text-base font-semibold cursor-pointer">
                    <%= post.user?.username %>
                  </h4>
                </a>
                <h6 class="text-xs opacity-50">
                  <%= formatDate(new Date(post.createdAt)) %>
                </h6>
              </div>
            </div>

            <!-- Post Image -->
            <div class="relative w-full h-[60vw] sm:h-[45vw] lg:h-[350px] mt-3 bg-sky-100 overflow-hidden">
              <img data-postid="<%= post._id %>" src="data:<%= post.postImage.contentType %>;base64,<%= post.postImage.data?.toString('base64') %>" alt=""
                class="postimg w-full h-full object-cover">
            </div>

            <!-- Post Options -->
            <div class="options w-full px-4 py-2 flex justify-between items-center text-[1.4rem]">
              <div class="flex gap-3">
                <a href="/like/post/<%= post._id %>">
                  <% if (post.likes.indexOf(user._id)===-1) { %>
                    <i class="heart ri-heart-3-line"></i>
                    <% } else { %>
                      <i class="heart ri-heart-3-fill text-red-500"></i>
                      <% } %>
                </a>
                <a href="https://www.beeper.com/">
                  <i class="ri-chat-3-line"></i>
                </a>

                <!-- Share Dialog -->
                <div class="relative inline-block">
                  <i class="share-btn ri-share-circle-line text-xl cursor-pointer"></i>
                  <div
                    class="share-dialog hidden absolute -bottom-10 -left-5 mt-2 w-72 bg-zinc-900 text-white rounded-xl shadow-lg p-4 z-50 border border-zinc-700">
                    <div class="flex justify-between items-start">
                      <div>
                        <h2 class="text-sm font-semibold">Share on Socials</h2>
                        <p class="text-xs text-zinc-400 mt-1">
                          Share this review with your friends and followers!
                        </p>
                      </div>
                      <button class="close-dialog text-lg leading-none">&times;</button>
                    </div>
                    <div class="flex items-center gap-4 mt-4 text-2xl">
                      <i class="ri-twitter-fill cursor-pointer hover:text-sky-400" data-link="twitter"></i>
                      <i class="ri-linkedin-box-fill cursor-pointer hover:text-sky-600" data-link="linkedin"></i>
                      <i class="ri-facebook-circle-fill cursor-pointer hover:text-blue-500" data-link="facebook"></i>
                      <i class="copy-link ri-file-copy-line cursor-pointer hover:text-green-400"></i>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex justify-center gap-5">
                <% if (user.savedPosts.indexOf(post._id)===-1) { %>
                  <i data-postid="<%= post._id %>" class="save ri-bookmark-line cursor-pointer"></i>
                  <% } else { %>
                    <i data-postid="<%= post._id %>" class="save ri-bookmark-fill text-zinc-100 cursor-pointer"></i>
                    <% } %>
                      <% if (user && String(user?._id)===String(post.user?._id)) { %>
                        <a href="/delete/<%= post._id %>">
                          <i class="text-red-400 hover:text-red-600 ri-delete-bin-line cursor-pointer"></i>
                        </a>
                        <% } %>
              </div>
            </div>

            <!-- Likes and Caption -->
            <h3 class="likeval px-4 text-sm leading-none tracking-tight">
              <%= post.likes.length %> likes
            </h3>
            <a href="/post/<%= post._id %>" class="postview px-4 text-sm leading-none tracking-tight opacity-50">
              View Post
            </a>
            <h2 class="text-white font-light text-sm mt-2 px-4 pb-4">
              <span class="font-semibold pr-1">
                <%= post.user?.username %>
              </span>
              <%= post.caption %>
            </h2>
          </div>
          <% }) %>
            <% } else { %>
              <h3 class="text-zinc-300 text-xl mt-20 opacity-30 ml-5 font-semibold col-span-full text-center">No Posts
                yet ...</h3>
              <% } %>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
    integrity="sha512-7eHRwcbYkK4d9g/6tD/mhkf++eoTHwpNM9woBxtPUBWm67zeAfFC+HrdoE2GanKeocly/VxeLvIqwvCdk7qScg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // --- Scroll position persistence
    document.addEventListener("DOMContentLoaded", function () {
      const scrollpos = localStorage.getItem('scrollpos');
      if (scrollpos) window.scrollTo(0, scrollpos);
    });
    window.onbeforeunload = () => localStorage.setItem('scrollpos', window.scrollY);

    // --- Rotating Story Animation
    document.querySelectorAll('.rotating-ring').forEach(ring => {
      const ringBorder = ring.querySelector('.ring-border');
      ring.addEventListener('click', () => {
        ringBorder.classList.add('spin-border');
        setTimeout(() => {
          ringBorder.classList.remove('spin-border');
          ringBorder.style.background = 'white';
        }, 5000);
      });
    });

    // --- Like / Save / Heart animation
    document.querySelector(".parent").addEventListener("click", function (dets) {
      if (dets.target.classList.contains("postimg")) {
        const post = dets.target.closest(".post");
        const heart = post.querySelector(".heart");
        const likeVal = post.querySelector(".likeval");
        const postId = dets.target.dataset.postid;

        // Toggle heart icon visually
        const liked = heart.classList.contains("ri-heart-3-line");
        heart.classList.toggle("ri-heart-3-line", !liked);
        heart.classList.toggle("ri-heart-3-fill", liked);
        heart.classList.toggle("text-red-500", liked);

        // Instant like count update (no delay)
        let currentLikes = parseInt(likeVal.textContent) || 0;
        likeVal.textContent = liked
          ? currentLikes + 1 + " likes"
          : currentLikes - 1 + " likes";

        // Sync with backend
        fetch(`/like/${postId}`)
          .then(res => res.json())
          .then(data => {
            // use the correct field name returned by backend
            const likesArray = data.likes || [];
            likeVal.textContent = likesArray.length + " likes";
          })
          .catch(err => console.error("Like update failed:", err));

        // Heart animation
        const icon = document.createElement("i");
        icon.classList.add(
          "ri-heart-3-fill",
          "text-red-700",
          "text-6xl",
          "absolute",
          "top-1/2",
          "left-1/2",
          "-translate-x-1/2",
          "-translate-y-1/2",
          "z-[9]"
        );
        dets.target.parentNode.appendChild(icon);

        gsap.fromTo(icon, { scale: 0.5, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.3 });
        gsap.to(icon, {
          scale: 0,
          opacity: 0,
          duration: 0.4,
          delay: 0.4,
          onComplete: () => icon.remove(),
        });
      }

      // Save post
      if (dets.target.classList.contains("save")) {
        const id = dets.target.dataset.postid;
        fetch(`/save/${id}`)
          .then(res => res.json())
          .then(() => {
            dets.target.classList.toggle("ri-bookmark-line");
            dets.target.classList.toggle("ri-bookmark-fill");
            dets.target.classList.toggle("text-zinc-100");
          })
          .catch(err => console.error("Save failed:", err));
      }
    });

    // --- Share Dialog Logic
    document.querySelectorAll('.share-btn').forEach((btn) => {
      const post = btn.closest('.post');
      const dialog = post.querySelector('.share-dialog');
      const closeBtn = dialog.querySelector('.close-dialog');
      const copyLink = dialog.querySelector('.copy-link');
      const socialIcons = dialog.querySelectorAll('[data-link]');
      const baseUrl = window.location.hostname === "localhost"
        ? "http://localhost:3000"
        : "https://sannsta.onrender.com";

      // ✅ Get postId safely from post's image or any element with data-postid
      const postId = post.querySelector("[data-postid]")?.dataset.postid;

      // Toggle dialog visibility
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.share-dialog').forEach(d => d.classList.add('hidden'));
        dialog.classList.toggle('hidden');
      });

      closeBtn.addEventListener('click', () => dialog.classList.add('hidden'));

      document.addEventListener('click', (e) => {
        if (!dialog.contains(e.target) && e.target !== btn) {
          dialog.classList.add('hidden');
        }
      });

      // ✅ Copy post link correctly
      copyLink.addEventListener('click', () => {
        const postUrl = `${baseUrl}/post/${postId}`;
        navigator.clipboard.writeText(postUrl);
        copyLink.classList.replace('ri-file-copy-line', 'ri-check-line');
        copyLink.classList.add('text-green-400');
        copyLink.style.pointerEvents = 'none';
        setTimeout(() => {
          copyLink.classList.replace('ri-check-line', 'ri-file-copy-line');
          copyLink.classList.remove('text-green-400');
          copyLink.style.pointerEvents = 'auto';
        }, 1500);
      });

      // ✅ Social share links
      socialIcons.forEach((icon) => {
        icon.addEventListener('click', () => {
          const shareUrl = encodeURIComponent(`${baseUrl}/post/${postId}`);
          const title = encodeURIComponent(document.title);
          const links = {
            twitter: `https://twitter.com/intent/tweet?url=${shareUrl}&text=${title}`,
            linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`,
            facebook: `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`,
          };
          window.open(links[icon.dataset.link], "_blank");
        });
      });
    });


  </script>

  <% include ./partials/footer.ejs %>