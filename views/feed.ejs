<% include ./partials/header.ejs %>
  <style>
    @keyframes spin-ring {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .spin-border {
      animation: spin-ring 2s linear infinite;
    }
  </style>

  <div class="w-full min-h-screen bg-[#2B2B2B] text-white py-5">
    <!-- Navbar -->
    <div class="w-full px-4 md:px-8 lg:px-12 flex items-center justify-between">
      <a href="/feed">
        <img class="w-1/4 md:w-32 lg:w-40" src="/images/logo.png" alt="">
      </a>
      <div class="icons -mt-2 flex gap-5 items-center text-xl md:text-2xl">
        <a href="/story/add">
          <i class="ri-add-circle-line"></i>
        </a>
        <a href="https://www.messenger.com/">
          <i class="ri-messenger-line"></i>
        </a>
      </div>
    </div>

    <!-- Story Section -->
    <div class="story px-3 flex gap-3 overflow-auto mt-5 md:justify-center">
      <% if (stories.length> 0) { %>
        <% stories.forEach(story=> { %>
          <a href="/story/<%= story.user.username %>">
            <div class="rotating-ring circle flex-shrink-0 relative w-[18vw] h-[18vw] md:w-[90px] md:h-[90px]">
              <div class="ring-border absolute inset-0 rounded-full"
                style="background: conic-gradient(from 0deg, #8b5cf6, #ec4899, #f97316, #8b5cf6); padding: 3px;">
              </div>
              <div class="absolute inset-[3px] rounded-full overflow-hidden bg-black">
                <img class="w-full h-full object-cover object-top" src="/images/uploads/<%= story.user.profileImage %>"
                  alt="">
              </div>
            </div>
          </a>
          <% }) %>
            <% } %>
    </div>

    <!-- Feed Grid -->
    <div class="parent posts mb-20 mt-8 max-w-6xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 px-4">
      <% if (posts.length> 0) { %>
        <% posts.reverse().forEach(post=> { %>
          <div
            class="post w-full bg-[#1F1F1F] rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300">
            <div class="title px-4 pt-4 flex items-center gap-3">
              <a href="/story/<%= post.user.username %>">
                <div class="rotating-ring relative w-12 h-12 flex-shrink-0">
                  <div class="ring-border absolute inset-0 rounded-full"
                    style="background: conic-gradient(from 0deg, #8b5cf6, #ec4899, #f97316, #8b5cf6); padding: 2px;">
                  </div>
                  <div class="absolute inset-[2px] rounded-full overflow-hidden bg-black">
                    <img src="/images/uploads/<%= post.user.profileImage %>" alt=""
                      class="w-full h-full rounded-full object-cover">
                  </div>
                </div>
              </a>
              <div>
                <h4 class="text-sm md:text-base font-semibold">
                  <%= post.user.username %>
                </h4>
                <h6 class="text-xs opacity-50">
                  <%= formatDate(new Date(post.createdAt)) %>
                </h6>
              </div>
            </div>

            <!-- Post Image -->
            <div class="relative w-full h-[60vw] sm:h-[45vw] lg:h-[350px] mt-3 bg-sky-100 overflow-hidden">
              <img data-postid="<%= post._id %>" src="/images/uploads/<%= post.postImage %>" alt=""
                class="postimg w-full h-full object-cover">
            </div>

            <!-- Post Options -->
            <div class="options w-full px-4 py-3 flex justify-between items-center text-[1.4rem]">
              <div class="flex gap-3">
                <a href="/like/post/<%= post._id %>">
                  <% if (post.likes.indexOf(user._id)===-1) { %>
                    <i class="heart ri-heart-3-line"></i>
                    <% } else { %>
                      <i class="heart ri-heart-3-fill text-red-500"></i>
                      <% } %>
                </a>
                <a href="https://www.beeper.com/">
                  <i class="ri-chat-3-line"></i>
                </a>

                <!-- Share Dialog -->
                <div class="relative inline-block">
                  <i id="share-btn" class="ri-share-circle-line text-xl cursor-pointer"></i>
                  <div id="share-dialog"
                    class="hidden absolute left-1/2 mt-2 w-72 bg-zinc-900 text-white rounded-xl shadow-lg p-4 z-50 border border-zinc-700">
                    <div class="flex justify-between items-start">
                      <div>
                        <h2 class="text-sm font-semibold">Share on Socials</h2>
                        <p class="text-xs text-zinc-400 mt-1">
                          Share this review with your friends and followers!
                        </p>
                      </div>
                      <button id="close-dialog" class="text-lg leading-none">&times;</button>
                    </div>
                    <div class="flex items-center gap-4 mt-4 text-2xl">
                      <i class="ri-twitter-fill cursor-pointer hover:text-sky-400" data-link="twitter"></i>
                      <i class="ri-linkedin-box-fill cursor-pointer hover:text-sky-600" data-link="linkedin"></i>
                      <i class="ri-facebook-circle-fill cursor-pointer hover:text-blue-500" data-link="facebook"></i>
                      <i id="copy-link" class="ri-file-copy-line cursor-pointer hover:text-green-400"></i>
                    </div>
                  </div>
                </div>
              </div>

              <% if (user.savedPosts.indexOf(post._id)===-1) { %>
                <i data-postid="<%= post._id %>" class="save ri-bookmark-line"></i>
                <% } else { %>
                  <i data-postid="<%= post._id %>" class="save ri-bookmark-fill text-zinc-100"></i>
                  <% } %>
            </div>

            <!-- Likes and Caption -->
            <h3 class="likeval px-4 text-sm leading-none tracking-tight">
              <%= post.likes.length %> likes
            </h3>
            <h2 class="text-white font-light text-sm mt-2 px-4 pb-4">
              <span class="font-semibold pr-1">
                <%= post.user.username %>
              </span>
              <%= post.caption %>
            </h2>
          </div>
          <% }) %>
            <% } else { %>
              <h3 class="text-zinc-300 text-xl mt-20 opacity-30 ml-5 font-semibold col-span-full text-center">No Posts
                yet ...</h3>
              <% } %>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
    integrity="sha512-7eHRwcbYkK4d9g/6tD/mhkf++eoTHwpNM9woBxtPUBWm67zeAfFC+HrdoE2GanKeocly/VxeLvIqwvCdk7qScg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // --- Scroll position persistence
    document.addEventListener("DOMContentLoaded", function () {
      const scrollpos = localStorage.getItem('scrollpos');
      if (scrollpos) window.scrollTo(0, scrollpos);
    });
    window.onbeforeunload = () => localStorage.setItem('scrollpos', window.scrollY);

    // --- Rotating Story Animation
    document.querySelectorAll('.rotating-ring').forEach(ring => {
      const ringBorder = ring.querySelector('.ring-border');
      ring.addEventListener('click', () => {
        ringBorder.classList.add('spin-border');
        setTimeout(() => {
          ringBorder.classList.remove('spin-border');
          ringBorder.style.background = 'white';
        }, 5000);
      });
    });

    // --- Like / Save / Heart animation
    document.querySelector(".parent").addEventListener("click", function (dets) {
      if (dets.target.classList.contains("postimg")) {
        const post = dets.target.closest(".post");
        const heart = post.querySelector(".heart");

        if (heart.classList.contains("ri-heart-3-line")) {
          heart.classList.replace("ri-heart-3-line", "ri-heart-3-fill");
          heart.classList.add("text-red-500");
        } else {
          heart.classList.replace("ri-heart-3-fill", "ri-heart-3-line");
          heart.classList.remove("text-red-500");
        }

        fetch(`/like/${dets.target.dataset.postid}`)
          .then(res => res.json())
          .then(data => {
            post.querySelector(".likeval").textContent = data.like.length + " likes";
          });

        const icon = document.createElement("i");
        icon.classList.add("ri-heart-3-fill", "text-red-700", "text-6xl", "absolute", "top-1/2", "left-1/2",
          "-translate-x-1/2", "-translate-y-1/2", "z-[9]");
        dets.target.parentNode.appendChild(icon);

        gsap.fromTo(icon, { scale: .5, opacity: 0 }, { scale: 1, opacity: 1, duration: .3 });
        gsap.to(icon, {
          scale: 0,
          opacity: 0,
          duration: .4,
          delay: .4,
          onComplete: () => icon.remove()
        });
      }

      // Save post
      if (dets.target.classList.contains("save")) {
        const id = dets.target.dataset.postid;
        fetch(`/save/${id}`).then(res => res.json()).then(() => {
          dets.target.classList.toggle("ri-bookmark-line");
          dets.target.classList.toggle("ri-bookmark-fill");
          dets.target.classList.toggle("text-zinc-100");
        });
      }
    });

    // --- Share Dialog Logic
    const shareBtn = document.getElementById("share-btn");
    const shareDialog = document.getElementById("share-dialog");
    const closeDialog = document.getElementById("close-dialog");
    const copyLink = document.getElementById("copy-link");
    const socialIcons = document.querySelectorAll("[data-link]");
    const baseUrl = window.location.hostname === "localhost"
      ? "http://localhost:3000"
      : "https://sannsta.onrender.com";

    shareBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      shareDialog.classList.toggle("hidden");
    });

    document.addEventListener("click", (e) => {
      if (!shareDialog.contains(e.target) && e.target !== shareBtn) {
        shareDialog.classList.add("hidden");
        resetIcons();
      }
    });

    closeDialog.addEventListener("click", () => {
      shareDialog.classList.add("hidden");
      resetIcons();
    });

    copyLink.addEventListener("click", () => {
      navigator.clipboard.writeText(baseUrl + window.location.pathname);
      copyLink.classList.replace("ri-file-copy-line", "ri-check-line");
      copyLink.classList.add("text-green-400");
      copyLink.style.pointerEvents = "none";
    });

    socialIcons.forEach((icon) => {
      icon.addEventListener("click", () => {
        if (icon.classList.contains("selected")) return;
        icon.classList.add("selected", "opacity-50");
        icon.style.pointerEvents = "none";

        const shareUrl = encodeURIComponent(baseUrl + window.location.pathname);
        const title = encodeURIComponent(document.title);

        const links = {
          twitter: `https://twitter.com/intent/tweet?url=${shareUrl}&text=${title}`,
          linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`,
          facebook: `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`
        };
        window.open(links[icon.dataset.link], "_blank");
      });
    });

    function resetIcons() {
      copyLink.classList.replace("ri-check-line", "ri-file-copy-line");
      copyLink.classList.remove("text-green-400");
      copyLink.style.pointerEvents = "auto";
      socialIcons.forEach((icon) => {
        icon.classList.remove("selected", "opacity-50");
        icon.style.pointerEvents = "auto";
      });
    }
  </script>

  <% include ./partials/footer.ejs %>