<% include ./partials/header.ejs %>

    <div class="relative w-full min-h-screen bg-black flex items-center justify-center overflow-hidden">

        <!-- Progress Bars -->
        <div class="absolute top-5 left-4 right-4 flex gap-1 z-20 max-w-3xl mx-auto">
            <% if (user.stories && user.stories.length> 0) { %>
                <% user.stories.forEach((story, index)=> { %>
                    <div class="flex-1 h-[3px] bg-gray-700 rounded-full overflow-hidden">
                        <div id="bar-<%= index %>" class="w-0 h-full bg-white"></div>
                    </div>
                    <% }) %>
                        <% } else { %>
                            <div class="mx-auto text-center mt-10">
                                <h1 class="opacity-40 font-semibold text-[#dadada] text-lg">
                                    No Stories posted yet...
                                </h1>
                            </div>
                            <% } %>
        </div>
        <div class="absolute top-5 right-5 flex items-center gap-4 z-30">
            <!-- 3 Dots Menu -->
            <div class="relative">
                <button id="optionsBtn" class="text-white text-2xl sm:text-3xl hover:text-gray-300 transition absolute top-5 right-14"
                    onclick="toggleMenu(event)">
                    <i class="ri-more-2-line"></i>
                </button>

                <!-- Dropdown Menu -->
                <div id="optionsMenu"
                    class="hidden absolute top-16 right-0 mt-2 w-36 bg-gray-800 rounded-lg shadow-lg border border-gray-700 overflow-hidden">
                    <% if (stories.length > 0) { %>
                        <% stories.forEach(story => { %>
                            <a href="/delete/story/<%= story._id %>" class="block px-4 py-2 text-sm text-red-400 hover:bg-gray-700 hover:text-red-300 transition">
                                <i class="ri-delete-bin-6-line mr-2"></i> Delete Story
                            </a>
                        <% }) %>
                    <% } %>
                </div>
                <!-- Close Button -->
                <button onclick="window.history.back()"
                    class="absolute top-5 right-5 text-white text-3xl z-20 hover:text-gray-300 transition">
                    <i class="ri-close-line"></i>
                </button>
            </div>

        </div>

        <!-- User Info -->
        <% if (stories.length> 0) { %>
            <% stories.forEach((story)=> { %>
                <a href="/profile/<%= user.username %>"
                    class="absolute top-14 left-4 flex items-center gap-3 z-20 justify-center">
                    <img src="data:<%= user.profileImage.contentType %>;base64,<%= user.profileImage.data?.toString('base64') %>"
                        class="w-11 h-11 sm:w-12 sm:h-12 rounded-full border-2 border-white object-cover" alt="user">
                    <span class="text-[#dadada] font-semibold capitalize text-lg sm:text-xl tracking-tight">
                        <%= user.username %>
                    </span>
                    <h6 class="text-md opacity-50 text-[#dadada]">
                        <%= formatDate(new Date(story.createdAt)) %>
                    </h6>
                </a>
                <% }) %>
                    <% } %>


                        <!-- Story Images + Navigation -->
                        <% user.stories.forEach((story, index)=> { %>
                            <div class="story-container w-full h-full flex items-center justify-center">
                                <img src="data:<%= story.story.contentType %>;base64,<%= story.story.data?.toString('base64') %>"
                                    id="story-<%= index %>" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
               w-[90%] sm:w-[60%] h-full object-contain rounded-lg
               transition-opacity duration-500 <%= index === 0 ? 'opacity-100' : 'opacity-0' %>" alt="story">
                            </div>
                            <% }) %>

                                <!-- Navigation Buttons -->
                                <button id="prevBtn"
                                    class="absolute left-5 text-3xl text-white opacity-60 hover:opacity-100 transition z-20">
                                    <i class="ri-arrow-left-circle-line"></i>
                                </button>

                                <button id="nextBtn"
                                    class="absolute right-5 text-3xl text-white opacity-60 hover:opacity-100 transition z-20">
                                    <i class="ri-arrow-right-circle-line"></i>
                                </button>
    </div>

    <script>
        const stories = document.querySelectorAll('[id^="story-"]');
        const bars = document.querySelectorAll('[id^="bar-"]');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        let current = 0;
        const duration = 5000;
        let timer;

        function showStory(index) {
            if (index < 0 || index >= stories.length) return;

            // Reset current story
            stories.forEach((story, i) => {
                story.style.opacity = i === index ? '1' : '0';
            });

            // Update progress bars
            bars.forEach((bar, i) => {
                bar.style.transition = 'none';
                bar.style.width = i < index ? '100%' : '0%';
            });

            setTimeout(() => {
                bars[index].style.transition = `width ${duration / 1000}s linear`;
                bars[index].style.width = '100%';
            }, 50);

            // Clear previous timer
            clearTimeout(timer);

            // Auto move to next story
            timer = setTimeout(() => {
                if (index < stories.length - 1) {
                    current++;
                    showStory(current);
                } else {
                    window.history.back();
                }
            }, duration);
        }

        // Navigation buttons
        nextBtn.addEventListener('click', () => {
            clearTimeout(timer);
            if (current < stories.length - 1) {
                current++;
                showStory(current);
            } else {
                window.history.back();
            }
        });

        prevBtn.addEventListener('click', () => {
            clearTimeout(timer);
            if (current > 0) {
                current--;
                showStory(current);
            }
        });

        // Start story view
        if (stories.length > 0) showStory(current);

        function toggleMenu(event) {
                event.stopPropagation();
                const menu = document.getElementById("optionsMenu");
                menu.classList.toggle("hidden");
            }

            // Close menu if clicked outside
            window.addEventListener("click", () => {
                const menu = document.getElementById("optionsMenu");
                if (!menu.classList.contains("hidden")) {
                    menu.classList.add("hidden");
                }
            });
    </script>

    <% include ./partials/footer.ejs %>